<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FE Photos Admin</title>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:40px auto;padding:0 16px}
    input,button{font-size:16px;padding:10px 12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .box{border:1px solid #ddd;border-radius:14px;padding:16px;margin-top:16px}
    .muted{color:#666}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:12px}
    img{width:100%;border-radius:12px;border:1px solid #eee}
    .small{font-size:13px;color:#777}
    .pill{display:inline-block;background:#f3f3f3;border:1px solid #e6e6e6;border-radius:999px;padding:4px 10px;font-size:12px;color:#444}
  </style>
</head>
<body>
  <h1>ðŸ“¸ FE Photos â€“ Admin Upload</h1>
  <p class="muted">Use the technical 8-digit code (YYMMDDHH) and upload photos to that session.</p>

  <div class="box">
    <div class="row">
      <label>Admin code:</label>
      <input id="adminCode" type="password" placeholder="Admin code" />
      <span class="pill">required</span>
    </div>

    <div class="row" style="margin-top:10px">
      <label>Photo code (YYMMDDHH):</label>
      <input id="code" placeholder="YYMMDDHH (e.g. 26051614)" maxlength="8" inputmode="numeric" />
      <button id="btnNow" type="button">Now</button>
    </div>

    <div class="small" style="margin-top:8px">
      Format: YYMMDDHH (Paris time). Example: May 16, 2026 at 14:00 â†’ 26051614
    </div>

    <div class="row" style="margin-top:14px">
      <input id="files" type="file" accept="image/*" multiple />
      <button id="btnUpload" type="button">Upload</button>
    </div>

    <p class="muted" id="status" style="margin-top:12px"></p>
    <div class="muted" id="publicLink"></div>
    <div class="grid" id="preview"></div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const codeEl = document.getElementById('code');
    const adminCodeEl = document.getElementById('adminCode');
    const filesEl = document.getElementById('files');
    const previewEl = document.getElementById('preview');
    const linkEl = document.getElementById('publicLink');

    function setLink(code){
      const full = `${location.origin}/sessions/${code}`;
      linkEl.innerHTML = `Public link: <a href="${full}" target="_blank">${full}</a>`;
    }

    function toYYMMDDHHParis(d){
      // Use Europe/Paris and output YYMMDDHH
      const parts = new Intl.DateTimeFormat('en-GB', {
        timeZone: 'Europe/Paris',
        year: '2-digit',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        hourCycle: 'h23'
      }).formatToParts(d);

      const get = t => parts.find(p => p.type === t)?.value || '';
      const yy = get('year');
      const mm = get('month');
      const dd = get('day');
      const hh = get('hour');
      return `${yy}${mm}${dd}${hh}`;
    }

    function cleanCode(v){
      return (v || '').replace(/\D/g,'').slice(0,8);
    }

    function isValidCode(code){
      if (!/^\d{8}$/.test(code)) return false;
      const yy = Number(code.slice(0,2));
      const mm = Number(code.slice(2,4));
      const dd = Number(code.slice(4,6));
      const hh = Number(code.slice(6,8));
      return (mm>=1 && mm<=12 && dd>=1 && dd<=31 && hh>=0 && hh<=23);
    }

    document.getElementById('btnNow').onclick = () => {
      codeEl.value = toYYMMDDHHParis(new Date());
      setLink(codeEl.value);
    };

    codeEl.addEventListener('input', () => {
      codeEl.value = cleanCode(codeEl.value);
      if (isValidCode(codeEl.value)) setLink(codeEl.value);
    });

    document.getElementById('btnUpload').onclick = async () => {
      try {
        const adminCode = (adminCodeEl.value || '').trim();
        const code = cleanCode(codeEl.value);
        const files = Array.from(filesEl.files || []);

        if (!adminCode) return alert("Enter the admin code.");
        if (!isValidCode(code)) return alert("Enter a valid 8-digit photo code (YYMMDDHH).");
        if (!files.length) return alert("Select one or more images.");

        statusEl.textContent = "Preparing uploadâ€¦";
        previewEl.innerHTML = "";
        setLink(code);

        const folder = `fe_sessions/${code}`;

        const sigResp = await fetch('/api/sign', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder, adminCode })
        });

        const raw = await sigResp.text();
        let sig = null;
        try { sig = JSON.parse(raw); } catch {}

        if (!sigResp.ok) {
          statusEl.textContent = `Sign error: ${(sig && (sig.error || sig.message)) ? (sig.error || sig.message) : (raw.slice(0,200) || "Unauthorized")}`;
          return;
        }
        if (!sig || !sig.apiKey || !sig.signature || !sig.cloudName || !sig.timestamp) {
          statusEl.textContent = "Sign error: invalid response.";
          return;
        }

        for (const f of files) {
          statusEl.textContent = `Uploading ${f.name}â€¦`;

          const fd = new FormData();
          fd.append("file", f);
          fd.append("api_key", sig.apiKey);
          fd.append("timestamp", sig.timestamp);
          fd.append("signature", sig.signature);
          fd.append("folder", folder);

          const up = await fetch(`https://api.cloudinary.com/v1_1/${sig.cloudName}/image/upload`, {
            method:'POST',
            body: fd
          });

          const data = await up.json();
          if (!up.ok) {
            statusEl.textContent = `Upload failed: ${data?.error?.message || "Unknown error"}`;
            return;
          }

          const img = document.createElement('img');
          img.src = data.secure_url;
          previewEl.appendChild(img);
        }

        statusEl.textContent = "âœ… Upload complete.";
      } catch (e) {
        statusEl.textContent = `Unexpected error: ${e?.message || e}`;
      }
    };
  </script>
</body>
</html>
